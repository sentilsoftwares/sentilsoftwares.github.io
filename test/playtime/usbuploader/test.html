<!DOCTYPE html>
<html>
<head>
  <title>Send SysEx via WebMIDI</title>
</head>
<body>
  <h3>Send SysEx File via WebMIDI</h3>
  <input type="file" id="syxFile" accept=".syx" />
  <button onclick="sendSyxFile()">Send to MIDI Device</button>

  <script>
    async function sendSyxFile() {
      const fileInput = document.getElementById("syxFile");
      if (!fileInput.files.length) {
        alert("Please select a .syx file.");
        return;
      }

      const file = fileInput.files[0];
      const arrayBuffer = await file.arrayBuffer();
      const data = new Uint8Array(arrayBuffer);

      // Step 1: Parse the data into F0...F7 messages
      const sysexMessages = [];
      let i = 0;
      while (i < data.length) {
        if (data[i] === 0xF0) {
          const endIndex = data.indexOf(0xF7, i + 1);
          if (endIndex === -1) {
            console.warn("Unterminated SysEx message found, skipping...");
            break;
          }
          const message = data.slice(i, endIndex + 1);
          sysexMessages.push(message);
          i = endIndex + 1;
        } else {
          i++;
        }
      }

      console.log(`Parsed ${sysexMessages.length} SysEx messages`);

      // Step 2: Send them via WebMIDI
      try {
        const midiAccess = await navigator.requestMIDIAccess({ sysex: true });
        const outputs = Array.from(midiAccess.outputs.values());

        if (outputs.length === 0) {
          alert("No MIDI output devices found.");
          return;
        }

        const output = outputs[0]; // Change this if needed

        for (let idx = 0; idx < sysexMessages.length; idx++) {
          const message = sysexMessages[idx];
          output.send(message);
          console.log(`Sent SysEx message ${idx + 1} (length: ${message.length})`);

          // Optional delay between messages (e.g., 50ms)
          await new Promise(resolve => setTimeout(resolve, 50));
        }

        alert("All SysEx messages sent!");
      } catch (err) {
        console.error("MIDI error:", err);
        alert("Failed to access MIDI: " + err.message);
      }
    }
  </script>
</body>
</html>
